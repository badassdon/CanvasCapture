(function(e){var t=document.createElement("canvas");if(!t.getContext||!t.getContext("2d"))return!1;var n=t.toDataURL("image/png");if(n.indexOf("data:image/png")!==0)return!1;var r=function(e,t,n,r,i){if(typeof n=="object"){var s=[];for(var o in n)s.push(encodeURIComponent(o)+"="+encodeURIComponent(n[o]));n=s.join("&")}var u=new XMLHttpRequest;u.open(e,t,!0);if(typeof r=="object")for(var a in r)u.setRequestHeader(a,r[a]);return u.send(n),i&&(u.onreadystatechange=function(){u.readyState===4&&i(u)}),u},i={READY:1,CAPTURING:2,RENDERING:3,DOWNLOAD:4},s=function(e,t){this._canvas=e,this._context=e.getContext("2d"),this._prefix="",t&&(t.slice(-1)!=="/"&&(t+="/"),this._prefix=t),this._frameN=0,this._captureId=null,this._frameQueue=[],this._duration=0,this._previousTime=0,this._renderProgress=0,this._durationListeners=[],this._renderProgressListeners=[],this._state=i.READY,this._initWithServer()};s.prototype.start=function(){return this._state===i.READY?(this._state=i.CAPTURING,this._captureFrame(),!0):this._state===i.CAPTURING},s.prototype.stop=function(){return this._state===i.CAPTURING?(this._state=i.READY,this._previousTime=0,!0):!1},s.prototype.render=function(){this.stop();if(this._state===i.RENDERING)return!0;if(this._state!==i.READY)return!1;this._state=i.RENDERING;var e={fps:this._frameN/(this._duration/1e3)},t=this._prefix+"capture/"+this._captureId+"/render";r("POST",t,e,{"Content-Type":"application/x-www-form-urlencoded"});var n=this;setTimeout(function(){n._updateRenderProgress()},500)},s.prototype.addDurationListener=function(e){this._durationListeners.push(e)},s.prototype.addRenderProgressListener=function(e){this._renderProgressListeners.push(e)},s.prototype.getDuration=function(){return this._duration},s.prototype.getRenderProgress=function(){return Math.min(this._renderProgress,100)},s.prototype.getDownloadURL=function(){return this._prefix+"capture/"+this._captureId+"/canvas.mp4"};var o=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();s.prototype._initWithServer=function(){var e=this,t=this._prefix+"capture";r("GET",t,null,null,function(t){e._captureId=t.responseText;for(var n=0;n<e._frameQueue.length;n++){var i=e._frameQueue[n].frameN,s=e._frameQueue[n].data,o=e._prefix+"capture/"+e._captureId+"/frame/"+i;r("POST",o,s,{"Content-Type":"image/png"})}})},s.prototype._captureFrame=function(){if(this._state!==i.CAPTURING)return;var e=this;o(function(){e._captureFrame()});var t=(new Date).getTime();this._previousTime!==0&&(this._duration+=t-this._previousTime),this._previousTime=t;var n=this._canvas.toDataURL("image/png");n=n.substring(22);if(this._captureId){var s=this._prefix+"capture/"+this._captureId+"/frame/"+this._frameN;r("POST",s,n,{"Content-Type":"image/png"})}else this._frameQueue.push({frameN:this._frameN,data:n});this._frameN+=1;for(var u=0;u<e._durationListeners.length;u++){var a=e._durationListeners[u];a(e._duration)}},s.prototype._updateRenderProgress=function(){if(this._state!==i.RENDERING)return;setTimeout(function(){e._updateRenderProgress()},500);var e=this,t=this._prefix+"capture/"+this._captureId+"/render-progress";r("GET",t,null,null,function(t){e._renderProgress=parseInt(t.responseText,10),e._renderProgress>=100&&(e._state=i.DOWNLOAD);for(var n=0;n<e._renderProgressListeners.length;n++){var r=e._renderProgressListeners[n];r(e._renderProgress)}})},e.CanvasCapture=s})(window);